function [parity] = crc24q(msg)

% SYNTAX:
%   [parity] = crc24q(msg)
%
% INPUT:
%   msg = binary message
%
% OUTPUT:
%   parity = crc parity (24 bits)
%
% DESCRIPTION:
%   Applies CRC-24Q QualComm algorithm.

%----------------------------------------------------------------------------------------------
%                           goGPS v0.1 alpha
%
% Copyright (C) 2009 Mirko Reguzzoni*, Eugenio Realini**
% ('rtcm3torinex.c', by Dirk Stöcker, BKG Ntrip Client (BNC) Version 1.6.1
%  was used as a reference)
%
% * Laboratorio di Geomatica, Polo Regionale di Como, Politecnico di Milano, Italy
% ** Media Center, Osaka City University, Japan
%----------------------------------------------------------------------------------------------
%
%    This program is free software: you can redistribute it and/or modify
%    it under the terms of the GNU General Public License as published by
%    the Free Software Foundation, either version 3 of the License, or
%    (at your option) any later version.
%
%    This program is distributed in the hope that it will be useful,
%    but WITHOUT ANY WARRANTY; without even the implied warranty of
%    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%    GNU General Public License for more details.
%
%    You should have received a copy of the GNU General Public License
%    along with this program.  If not, see <http://www.gnu.org/licenses/>.
%----------------------------------------------------------------------------------------------

%CRC-24Q table (with a seed of 0, according to RTCM3.x specifications)

% table = zeros(1, 256);

% table(1,1) = 0;
% table(1,2) = 25578747;
% h = 25578747;
% 
% i = 2;
% 
% while(i < 256)
%     h = bitshift(h,1);
%     if bitand(h,16777216)
%         h = bitxor(h, 25578747);
%     end
%     for j = 1 : i
%         table(1, i+j) = bitxor(table(1, j), h);
%     end
%     i = i * 2;
% end
% 
% table = [ 0, ...
%    25578747, ...
%    42652941, ...
%    51157494, ...
%    76801761, ...
%    85305882, ...
%   102314988, ...
%   127893271, ...
%   144802105, ...
%   153603522, ...
%   170611764, ...
%   195893455, ...
%   204629976, ...
%   229911331, ...
%   246985429, ...
%   255786542, ...
%   281366153, ...
%   289604210, ...
%   307207044, ...
%   331995007, ...
%   341223528, ...
%   366011539, ...
%   383548773, ...
%   391786910, ...
%   409259952, ...
%   434275147, ...
%   451812029, ...
%   459822662, ...
%   485960017, ...
%   493970858, ...
%   511573084, ...
%   536588455, ...
%   537711081, ...
%   562732306, ...
%   579208420, ...
%   587221023, ...
%   614414088, ...
%   622427123, ...
%   638968325, ...
%   663990014, ...
%   682447056, ...
%   690691115, ...
%   707233245, ...
%   732023078, ...
%   742307377, ...
%   767097546, ...
%   783573820, ...
%   791818183, ...
%   818519904, ...
%   827315099, ...
%   843270765, ...
%   868550294, ...
%   878344577, ...
%   903624058, ...
%   919645324, ...
%   928440439, ...
%   946347609, ...
%   971920034, ...
%   987941716, ...
%   996444079, ...
%  1023146168, ...
%  1031648323, ...
%  1047604661, ...
%  1073176910, ...
%  1075422162, ...
%  1101000489, ...
%  1116960479, ...
%  1125464612, ...
%  1149912371, ...
%  1158416840, ...
%  1174442046, ...
%  1200020677, ...
%  1220027115, ...
%  1228828176, ...
%  1244854246, ...
%  1270135581, ...
%  1277936650, ...
%  1303218417, ...
%  1319178503, ...
%  1327980028, ...
%  1356655963, ...
%  1364894112, ...
%  1381382230, ...
%  1406170285, ...
%  1414466490, ...
%  1439254337, ...
%  1455808183, ...
%  1464046156, ...
%  1484614754, ...
%  1509630105, ...
%  1526184303, ...
%  1534195092, ...
%  1559136899, ...
%  1567147640, ...
%  1583636366, ...
%  1608651637, ...
%  1612018235, ...
%  1637039808, ...
%  1654630198, ...
%  1662643149, ...
%  1686541530, ...
%  1694554145, ...
%  1712079319, ...
%  1737100588, ...
%  1756689154, ...
%  1764933625, ...
%  1782457871, ...
%  1807248116, ...
%  1814500835, ...
%  1839290648, ...
%  1856880878, ...
%  1865124885, ...
%  1892695218, ...
%  1901490249, ...
%  1918560703, ...
%  1943840068, ...
%  1950603859, ...
%  1975883432, ...
%  1992888158, ...
%  2001683365, ...
%  2020720011, ...
%  2046292336, ...
%  2063296646, ...
%  2071798909, ...
%  2095209322, ...
%  2103711633, ...
%  2120781415, ...
%  2146353820, ...
%  2150844324, ...
%  2176125791, ...
%  2193199785, ...
%  2202000978, ...
%  2225119557, ...
%  2233920958, ...
%  2250929224, ...
%  2276210867, ...
%  2291320477, ...
%  2299824742, ...
%  2316833680, ...
%  2342412139, ...
%  2348884092, ...
%  2374462599, ...
%  2391537009, ...
%  2400041354, ...
%  2432043309, ...
%  2440054230, ...
%  2457656352, ...
%  2482671835, ...
%  2489708492, ...
%  2514723639, ...
%  2532260545, ...
%  2540271162, ...
%  2555873300, ...
%  2580661487, ...
%  2598198553, ...
%  2606436834, ...
%  2630119157, ...
%  2638357006, ...
%  2655960056, ...
%  2680747779, ...
%  2688521805, ...
%  2713311926, ...
%  2729788224, ...
%  2738032571, ...
%  2762764460, ...
%  2771008599, ...
%  2787550625, ...
%  2812340570, ...
%  2828932980, ...
%  2836945807, ...
%  2853487225, ...
%  2878508674, ...
%  2886594965, ...
%  2911616366, ...
%  2928092312, ...
%  2936105059, ...
%  2969229508, ...
%  2977731647, ...
%  2993688009, ...
%  3019260210, ...
%  3026796069, ...
%  3052368606, ...
%  3068390184, ...
%  3076892627, ...
%  3092994557, ...
%  3118273798, ...
%  3134295280, ...
%  3143090187, ...
%  3167272732, ...
%  3176068071, ...
%  3192023569, ...
%  3217303274, ...
%  3224036470, ...
%  3249318029, ...
%  3265278331, ...
%  3274079616, ...
%  3300459159, ...
%  3309260396, ...
%  3325286298, ...
%  3350567777, ...
%  3364578639, ...
%  3373083060, ...
%  3389108290, ...
%  3414686905, ...
%  3424158638, ...
%  3449737045, ...
%  3465696931, ...
%  3474201176, ...
%  3505367807, ...
%  3513378308, ...
%  3529867250, ...
%  3554882313, ...
%  3564915742, ...
%  3589931237, ...
%  3606485267, ...
%  3614496232, ...
%  3629001670, ...
%  3653789501, ...
%  3670343371, ...
%  3678581296, ...
%  3705523495, ...
%  3713761756, ...
%  3730249770, ...
%  3755037905, ...
%  3760600479, ...
%  3785390436, ...
%  3802980498, ...
%  3811224681, ...
%  3837121406, ...
%  3845365637, ...
%  3862890099, ...
%  3887680136, ...
%  3901207718, ...
%  3909220445, ...
%  3926745515, ...
%  3951766864, ...
%  3960754759, ...
%  3985776316, ...
%  4003366730, ...
%  4011379633, ...
%  4041440022, ...
%  4049942509, ...
%  4067012123, ...
%  4092584672, ...
%  4101021175, ...
%  4126593292, ...
%  4143597818, ...
%  4152099841, ...
%  4165138991, ...
%  4190418644, ...
%  4207423266, ...
%  4216218585, ...
%  4241562830, ...
%  4250357813, ...
%  4267428291, ...
%  4292707640];
% 
% parity = 0;
% 
% for i = 1 : 8 : length(msg)
%     cast = typecast(uint64(bitshift(parity,-16)),'uint8');
%     cast(1:3)
%     parity = bitxor(bitshift(parity,8), table(bitxor(bin2dec(msg(i:i+7)), cast(1)) + 1));
% end
% 
% parity = dec2bin(bitand(parity, 16777215), 24);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% % if (~table(1))
%     for i = 1 : 256
%         table(1, i) = bitshift(i-1,16);
%         for j = 1 : 8
%             h = bitshift(table(1, i),1);
%             if bitand(h, 16777216)
%                 table(1, i)= bitxor(table(1, i), 25578747);
%             end
%         end
%     end
% % end
% 
% parity = 0;
% 
% for i = 1 : 8 : length(msg)
%     cast = typecast(uint64(bitshift(parity,-16)),'uint8');
%     parity = bitxor(bitand(bitshift(parity,8), 16777215), table(bitxor(cast(1), bin2dec(msg(i:i+7))) + 1));
% end
% 
% parity = dec2bin(parity, 24);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

parity = 0;

for i = 1 : 8 : length(msg)
    parity = bitxor(parity, bitshift(bin2dec(msg(i:i+7)), 16));
    for j = 1 : 8
        parity = bitshift(parity, 1);
        if bitand(parity, 16777216)
            parity = bitxor(parity, 25578747);
        end
    end
end

parity = dec2bin(parity, 24);
